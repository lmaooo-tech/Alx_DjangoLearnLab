# ============================================================================
# AUTHOR API VIEWS - Step 4 Integration Demonstration
# ============================================================================
# 
# These views demonstrate how filtering, searching, and ordering can be
# applied to other models beyond Book. The same patterns are used.
#

# Add this code to the end of views.py

class AuthorFilterSet(FilterSet):
    """
    Custom FilterSet for Author model providing advanced filtering options.
    
    Demonstrates that filtering patterns can be applied to any model.
    """
    
    # Author name filter: case-insensitive substring search
    name = CharFilter(
        field_name='name',
        lookup_expr='icontains',
        label='Search by author name (partial match)',
        help_text='Filter authors by partial name match (e.g., "Tolkien")'
    )
    
    class Meta:
        model = Author
        fields = []


class AuthorListView(generics.ListAPIView):
    """
    API View for retrieving and filtering all authors.
    
    Purpose:
    - Displays a paginated list of all authors in the system
    - Provides full-text search across author names
    - Enables flexible ordering of authors
    - Uses AuthorSerializer for JSON serialization
    
    Permission:
    - AllowAny: Anyone can read/list authors (no authentication required)
    
    HTTP Methods Supported:
    - GET: Retrieve all authors with optional search and ordering
    
    Advanced Features:
    
    1. SEARCHING (using ?search parameter):
       - ?search=Tolkien - Full-text search across author name
       - Searches are case-insensitive and match partial strings
    
    2. ORDERING (using ?ordering parameter):
       - ?ordering=name - Order by author name (A-Z)
       - ?ordering=-name - Order by author name (Z-A)
       - ?ordering=id - Order by creation order (first added)
       - ?ordering=-id - Order by creation order (last added)
    
    3. PAGINATION:
       - ?page=1 - First page (default)
       - ?page=2 - Second page, etc.
    
    Response:
    - Returns a paginated list of author objects
    
    Examples:
    - GET /api/authors/
    - GET /api/authors/?search=King
    - GET /api/authors/?ordering=name&page=1
    - GET /api/authors/?search=Stephen&ordering=name
    
    Use Cases:
    - Display all authors in the system
    - Search for specific authors
    - Browse authors alphabetically
    - Show recently added authors
    """
    queryset = Author.objects.all().prefetch_related('books')
    serializer_class = AuthorSerializer
    permission_classes = [AllowAny]  # Public read access
    
    # ========== FILTERING & SEARCHING ==========
    filter_backends = [
        DjangoFilterBackend,      # Enable filtering
        filters.SearchFilter,     # Enable searching
        filters.OrderingFilter    # Enable ordering
    ]
    
    filterset_class = AuthorFilterSet
    
    search_fields = [
        'name'  # Search in author name
    ]
    
    # ========== ORDERING ==========
    ordering_fields = [
        'name',  # Sort by author name
        'id'     # Sort by creation order
    ]
    
    ordering = ['name']  # Default: alphabetical order
    
    def get_queryset(self):
        """
        Returns optimized queryset with related books.
        - Uses prefetch_related() for efficient book loading
        - Maintains pagination efficiency
        """
        return Author.objects.all().prefetch_related('books')


class AuthorDetailView(generics.RetrieveAPIView):
    """
    API View for retrieving a specific author and their books.
    
    Purpose:
    - Displays detailed information about a single author
    - Shows all books by the author
    - Uses AuthorSerializer with nested books
    
    Permission:
    - AllowAny: Anyone can read author details
    
    HTTP Methods Supported:
    - GET: Retrieve author details by ID
    
    URL Parameters:
    - pk (int): The primary key of the author
    
    Response:
    - Returns author object with nested books array
    
    Example:
    - GET /api/authors/1/
    
    Response Format:
    {
        "id": 1,
        "name": "J.R.R. Tolkien",
        "books": [
            {
                "id": 1,
                "title": "The Hobbit",
                "publication_year": 1937
            },
            ...
        ]
    }
    """
    queryset = Author.objects.all().prefetch_related('books')
    serializer_class = AuthorSerializer
    permission_classes = [AllowAny]


class AuthorCreateView(generics.CreateAPIView):
    """
    API View for creating new authors.
    
    Permission:
    - IsAuthenticated: Only authenticated users can create authors
    
    HTTP Methods Supported:
    - POST: Create a new author
    
    Request Body:
    {
        "name": "Author Name"
    }
    
    Response:
    - Status 201 Created: Returns the created author object
    - Status 400 Bad Request: If validation fails
    - Status 401 Unauthorized: If user is not authenticated
    """
    queryset = Author.objects.all()
    serializer_class = AuthorSerializer
    permission_classes = [IsAuthenticated]
    
    def perform_create(self, serializer):
        """Log author creation"""
        author = serializer.save()
        logger.info(f"Author created: {author.name} (ID: {author.id})")


class AuthorUpdateView(generics.UpdateAPIView):
    """
    API View for updating author information.
    
    Permission:
    - IsAuthenticated: Only authenticated users can update authors
    
    HTTP Methods Supported:
    - PUT: Replace entire author object
    - PATCH: Update specific fields
    
    URL Parameters:
    - pk (int): The primary key of the author
    """
    queryset = Author.objects.all()
    serializer_class = AuthorSerializer
    permission_classes = [IsAuthenticated]
    
    def perform_update(self, serializer):
        """Log author updates"""
        author = serializer.save()
        logger.info(f"Author updated: {author.name} (ID: {author.id})")


class AuthorDeleteView(generics.DestroyAPIView):
    """
    API View for deleting authors.
    
    Permission:
    - IsAuthenticated: Only authenticated users can delete authors
    
    HTTP Methods Supported:
    - DELETE: Remove an author
    
    URL Parameters:
    - pk (int): The primary key of the author
    
    Note:
    - Related books will be deleted due to CASCADE foreign key relationship
    """
    queryset = Author.objects.all()
    serializer_class = AuthorSerializer
    permission_classes = [IsAuthenticated]
